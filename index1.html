<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Контроль транспорта у шлагбаума</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif}
        body{background:#0d1117;color:#e6edf3;line-height:1.6;padding:20px;min-height:100vh}
        .wrapper{max-width:1000px;margin:0 auto}
        .header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #238636}
        .header h1{color:#3fb950;margin-bottom:15px;font-size:2.3rem}
        .upload-box{background:#161b22;padding:25px;border-radius:8px;margin-bottom:25px;text-align:center;border:1px solid #30363d}
        .file-box{margin:20px 0}
        .file-label{display:inline-block;padding:14px 28px;background:#238636;color:#fff;border-radius:6px;cursor:pointer;font-size:1.1rem;transition:all .25s}
        .file-label:hover{background:#2ea043}
        #videoInput{display:none}
        .video-box{position:relative;width:100%;background:#000;border-radius:8px;overflow:hidden;margin:20px 0}
        #videoPlayer{width:100%;display:block}
        #overlay{position:absolute;top:0;left:0;width:100%;height:100%}
        .controls{display:flex;justify-content:center;gap:15px;margin:25px 0;flex-wrap:wrap}
        .btn{padding:14px 32px;background:#1f6feb;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1.05rem;min-width:180px;transition:all .25s}
        .btn:hover{background:#2c78f3}
        .btn:disabled{background:#484f58;cursor:default}
        #processBtn{background:#238636}
        #processBtn:hover:not(:disabled){background:#2ea043}
        .status-box{padding:20px;background:#161b22;border-radius:8px;text-align:center;font-size:1.15rem;margin:20px 0;border:1px solid #30363d}
        .detected{background:rgba(248,81,73,0.15);border-color:#f85149;color:#f85149}
        .no-target{background:rgba(46,160,67,0.15);border-color:#3fb950;color:#3fb950}
        .notes{background:#161b22;padding:25px;border-radius:8px;margin-top:30px}
        .notes h2{color:#3fb950;margin-bottom:20px}
        .notes ul{padding-left:25px}
        .notes li{margin-bottom:12px}
    </style>
</head>
<body>
<div class="wrapper">
    <div class="header">
        <h1>Система контроля транспорта</h1>
        <p>Обнаружение автомобилей у шлагбаума</p>
    </div>

    <div class="upload-box">
        <h2>Выберите видеозапись (MP4)</h2>
        <div class="file-box">
            <label for="videoInput" class="file-label">Загрузить видео</label>
            <input type="file" id="videoInput" accept="video/mp4">
        </div>
    </div>

    <div class="video-box">
        <video id="videoPlayer" controls></video>
        <canvas id="overlay"></canvas>
    </div>

    <div class="controls">
        <button id="processBtn" class="btn" disabled>Запуск анализа</button>
        <button id="pauseBtn" class="btn" disabled>Приостановить</button>
        <button id="resetBtn" class="btn" disabled>Сбросить</button>
    </div>

    <div id="statusText" class="status-box">Статус: Ожидание загрузки видео</div>

    <div class="notes">
        <h2>Рекомендации:</h2>
        <ul>
            <li>Используйте браузер Chrome или Edge</li>
            <li>Загружайте видео в формате MP4</li>
            <li>Оптимальная длительность видео: до 2 минут</li>
            <li>Система распознаёт автомобили и мотоциклы</li>
            <li>Для повторного анализа перезагрузите страницу</li>
            <li>Основано на базе JS с использованием Tensorflow by SeniorSpeedex!</li>
        </ul>
    </div>
</div>

<script>
    const videoPlayer = document.getElementById('videoPlayer');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const videoInput = document.getElementById('videoInput');
    const processBtn = document.getElementById('processBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusText = document.getElementById('statusText');

    let detectionModel = null;
    let detectionActive = false;
    let animationFrameId = null;

    async function setupSystem() {
        statusText.textContent = "Загрузка модулей...";

        try {
            detectionModel = await cocoSsd.load();
            statusText.textContent = "Система готова. Загрузите видео.";
            statusText.className = "status-box no-target";
        } catch (err) {
            statusText.textContent = "Ошибка загрузки: " + err.message;
            statusText.className = "status-box detected";
        }
    }

    videoInput.addEventListener('change', function() {
        if (!this.files || !this.files[0]) return;

        const mediaFile = this.files[0];

        if (!mediaFile.type.includes('mp4')) {
            statusText.textContent = "Ошибка: требуется MP4-файл";
            statusText.className = "status-box detected";
            return;
        }

        const mediaURL = URL.createObjectURL(mediaFile);
        videoPlayer.src = mediaURL;

        videoPlayer.onloadedmetadata = function() {
            overlay.width = videoPlayer.videoWidth;
            overlay.height = videoPlayer.videoHeight;

            statusText.textContent = "Видео загружено. Запустите анализ.";
            statusText.className = "status-box no-target";
            processBtn.disabled = false;
            resetBtn.disabled = false;
        };
    });

    processBtn.addEventListener('click', function() {
        if (!videoPlayer.src) return;

        videoPlayer.play();
        detectionActive = true;
        processBtn.disabled = true;
        pauseBtn.disabled = false;

        statusText.textContent = "Анализ видеопотока...";
        statusText.className = "status-box";

        runDetection();
    });

    pauseBtn.addEventListener('click', function() {
        detectionActive = false;
        videoPlayer.pause();
        processBtn.disabled = false;
        pauseBtn.disabled = true;

        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }

        statusText.textContent = "Анализ приостановлен";
        statusText.className = "status-box";
    });

    resetBtn.addEventListener('click', function() {
        detectionActive = false;
        videoPlayer.pause();
        videoPlayer.src = "";
        overlay.width = 0;
        overlay.height = 0;
        processBtn.disabled = true;
        pauseBtn.disabled = true;
        resetBtn.disabled = true;
        videoInput.value = "";

        statusText.textContent = "Ожидание загрузки видео";
        statusText.className = "status-box";

        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
    });

    async function runDetection() {
        if (!detectionActive || videoPlayer.paused || videoPlayer.ended) {
            pauseBtn.click();
            return;
        }

        try {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            ctx.drawImage(videoPlayer, 0, 0, overlay.width, overlay.height);

            const results = await detectionModel.detect(overlay);
            let targetFound = false;

            for (const item of results) {
                if ((item.class === 'car' || item.class === 'motorcycle') && item.score > 0.6) {
                    targetFound = true;

                    ctx.beginPath();
                    ctx.rect(...item.bbox);
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#f85149';
                    ctx.stroke();

                    ctx.fillStyle = '#f85149';
                    ctx.font = '16px Arial';
                    ctx.fillText(
                        `${item.class} ${Math.round(item.score * 100)}%`,
                        item.bbox[0],
                        item.bbox[1] > 15 ? item.bbox[1] - 8 : 15
                    );
                }
            }

            if (targetFound) {
                statusText.textContent = "ТРАНСПОРТ ОБНАРУЖЕН!";
                statusText.className = "status-box detected";
            } else {
                statusText.textContent = "Транспорт не обнаружен";
                statusText.className = "status-box no-target";
            }

        } catch (err) {
            statusText.textContent = "Ошибка обработки";
            statusText.className = "status-box detected";
        }

        animationFrameId = requestAnimationFrame(runDetection);
    }

    window.addEventListener('load', setupSystem);
</script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.1.0"></script>
</body>
</html>